# Decentralized Exchanges and the Automated Market Makers

Welcome on to the crypto stage: the decentralized exchange! Wait, but if there isn't a third party making the exchanges, who's setting the prices? Who's deciding if a trade goes through? No one. And that's the point. 

> The anti-state anarchist would rejoice that all their money will never be frozen by CEXs on Anti-Money Laundering suspision. 

Without no one setting prices, but also no one approving or rejecting trades we have a free market. By that I mean, we have finanical equity in a way that was never possible before. By doing away with the gerry-mandering of voting distrcits, we have fairer elections. By providing structure of decentralized exchanges, we both reduce scam and redcue inequitites in the system. 


> Perhaps I should add a personal note here. The single idea that changes my mind from "crypto is just memes and scams" to "crypto is a powerful invention for financial sovereignty, equity, and freedom" was the idea that crypto provides finanical access without gatekeeping. When Robert Moses built bridges in Long Island that were intentionally too short for buses to pass under, it systematically disallowed those reliant on public transit to access the public beaches and communities on the far side. By way of the bridges, it was a modal filter; only those wealthy enough to own a car could enjoy the otherwise free beaches.

>When black families are denied homebuying loans in white neighborhoods, it is systemic racism in the finanical sector. Imagine instead a future where crypto and it's decentralization at the core remove the too-short bridges and allow loans to pass through meeting eligibility critia and not rejected off skin-color. Cryptocurrency allow transactions without borders, removing the high Western Union fees of split families sending money across borders. Cryptocurrency is near instantenous (~10min) and it could entirely dismantle the pay-day loan shark system.

>Cryptocurrency needs a cell phone to participate in a global economy for wealth building and transferral. That is a much much lower barrier of entry. All we really need is available education. (**cough cough [TLC](https://techlearningcollective.com/donate/)**)

>Thank you for coming to my TED talk. On with the show.



In traditional financial markets, market makers are typically sophisticated financial institutions that use advanced algorithms and maintain substantial capital reserves to continuously quote bid and ask prices. These market makers profit from the spread between buying and selling prices while providing liquidity to the market. They rely on order books, where buyers and sellers place orders at specific prices, and the market maker facilitates matches between these orders.

However, cryptocurrency markets have introduced an revolutionary innovation: **Automated Market Makers (AMMs)**. AMMs represent a fundamental shift from traditional order book models to algorithmic liquidity provision through [smart contracts](../module-2-blockchain/2.1-main-article.md#smart-contracts). These are the core engineering methods behind the decentralized exchanges.

## Automated Market Makers and Liquidity Pools

Automated Market Makers like **Uniswap**, **SushiSwap**, and **PancakeSwap** operate without traditional order books. Instead, they use liquidity pools - smart contracts that hold reserves of two or more tokens and enable trading between them through mathematical formulas.

**How Liquidity Pools Work:**

In a liquidity pool, users (called liquidity providers or LPs) deposit equal values of two tokens into a smart contract. For example, in an ETH/USDC pool, if ETH is worth $2,000, an LP might deposit 1 ETH and $2,000 USDC. In return, they receive LP tokens representing their share of the pool.

When traders want to swap tokens, they trade directly with the pool rather than with another trader. The smart contract automatically calculates exchange rates based on the ratio of tokens in the pool, ensuring that the product of the token quantities remains constant (the constant product formula).

## Constant Product Formula and Price Discovery

The most common AMM model uses the **constant product formula**: x Ã— y = k, where x and y represent the quantities of two tokens in the pool, and k is a constant.

For example, if a pool contains 100 ETH and 200,000 USDC, then k = 20,000,000. When someone buys 10 ETH from the pool, they must deposit enough USDC to maintain this constant. The larger the trade relative to the pool size, the more the price moves, effecting the **slippage**.

[TODO: Insert a diagram of slippage]

This mechanism creates automatic price discovery without human intervention. As traders buy and sell, the ratio of tokens in the pool changes, which adjusts the exchange rate. If the pool price diverges from external market prices, arbitrageurs can profit by trading to bring prices back in line.

When a grocery store has too many Doritos on the shelf, it reduces the price to encourage customers to exchange Doritos for dollar bills. When the store owner is low on Doritos, but has dollar bills, a vendor will come with the reverse trade to bring the dollars and Doritios into balance. Thus always providing Doritos to late-night snackers. 

While you might think of asking for a discount on bulk exchanges, the opposite is true, and slippage is a cost of bulk orders. The more an individual wants to put the Dorito distribution system out of balance, the more they will pay for the universal disturbance to The Force. All of this is done automatically, with the AMMs, so the store owner nevers has to check and balance it's Dorito supply. 

## Dynamic Fees and Incentive Structures

AMMs implement sophisticated fee structures that differ significantly from traditional exchanges:

**Trading Fees:** Most AMMs charge fees (typically 0.1% to 1%) on each trade, which are distributed to liquidity providers. This creates a continuous revenue stream for LPs, incentivizing them to provide liquidity.

**Dynamic Fees:** Advanced AMMs like Uniswap V3 allow for concentrated liquidity and dynamic fee tiers. LPs can specify price ranges where they want to provide liquidity, allowing for more capital-efficient market making. 

This enables LPs to set rules like: 
- When volatility is low (below X value): reduce fees
- When volatility is high: raise fees
- When Mercury is in retrograde: raise fees

**Yield Farming:** Many protocols offer additional rewards in their native tokens to liquidity providers, creating complex incentive structures that can dramatically affect liquidity provision and market dynamics.

## Smart Contract Innovation and Risks

Smart contracts enable AMMs to operate 24/7 without human intervention, providing several advantages over traditional systems:

**Transparency:** All transactions and pool states are recorded on the blockchain, providing complete transparency into market operations.

**Permissionless Access:** Anyone can become a liquidity provider or trader without going through traditional gatekeepers like banks or brokers.

**Composability:** AMMs can be integrated with other DeFi protocols, creating complex financial products and strategies.

However, smart contracts also introduce new risks:

**Smart Contract Risk:** Bugs in code can lead to loss of funds. Even audited contracts can have vulnerabilities.

Case Study: A notable example is the **Wormhole Bridge hack (February 2022)**, where a bug in the smart contract's signature verification system allowed an attacker to mint 120,000 ETH (worth ~$320 million at the time) without providing proper collateral. The attacker exploited a flaw in how the bridge verified cross-chain transactions, essentially creating ETH out of thin air. While Wormhole's parent company eventually covered the losses, users were temporarily at risk of losing their funds if the protocol had collapsed.

**Impermanent Loss:** LPs face the risk that the relative price of their deposited tokens changes, potentially resulting in less value than simply holding the tokens. 

For our grocery store example, while store owner has a balance of Doritos and dollar bills on Monday, but if by Friday the price of Doritos has significantly changed then the balance of Dorito/dollars constant product formula has changed without any sales/exchanges made. The store owner loses value by needing to reblance in one direction or the other. 

**Maximal Extractable Value (MEV):** The transparent nature of open ledger blockchains can allow sophisticated actors to extract value through techniques like front-running. MEV refers to the maximum profit that can be extracted from block production beyond the standard block reward and gas fees by reordering, including, or censoring transactions within a block. 

In simple terms, MEV occurs when validators/miners use their position to profit from knowing transaction order before it's finalized. Common MEV strategies include:

- **Front-running:** Seeing a profitable trade and placing your own trade ahead of it
- **Back-running:** Placing trades immediately after large transactions to capture price movements
- **Sandwich attacks:** Placing trades both before and after a victim's transaction to profit from price impact

MEV is particularly relevant in DeFi because all pending transactions are visible in the mempool, allowing sophisticated actors to extract value at the expense of regular users. 

> MEV is only a risk to open ledgers like Bitcoin and ETH. **This threat is entirely elminated on opaque ledgers like Zcash or Monero.**

Note continued: Because the zk-SNARKs of Zcash's verification system mean that the server validating and mining the blocks of the zcash network don't actually see the transactions pre-finalization their is no way to use this information to extract value. There is no insider trading, when there is zero insider knowledge.
